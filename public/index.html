<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ada (Mobile Wrapper)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: -apple-system, system-ui, sans-serif;
      background: #0a0a0a;
      color: #f5f5f5;
    }
    body {
      margin: 0;
      background: #0a0a0a;
    }
    #app {
      max-width: 700px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #111;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid #222;
    }
    header h1 {
      font-size: 16px;
      margin: 0;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    header select {
      background: #222;
      color: #f5f5f5;
      border-radius: 6px;
      border: 1px solid #333;
      padding: 4px 8px;
      font-size: 14px;
    }
    main {
      padding: 12px 16px 24px;
      line-height: 1.6;
      font-size: 17px;
    }
    #text {
      overflow-wrap: break-word;
      word-wrap: break-word;
    }
    #text * {
      white-space: normal !important;
    }
    /* kill original manual column breaks */
    #text br,
    #overlay-content br {
      display: none;
    }
    #text a {
      color: #6ab4ff;
      text-decoration: underline;
      text-decoration-thickness: 1px;
      text-underline-offset: 2px;
    }

    /* Fullscreen overlay for notes */
    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      z-index: 100;
      align-items: stretch;
      justify-content: center;
    }
    #overlay.visible {
      display: flex;
    }
    #overlay-inner {
      background: #0b0b0b;
      border-radius: 0;
      width: 100%;
      max-width: 700px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 40px rgba(0,0,0,0.6);
    }
    #overlay-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-bottom: 1px solid #222;
      background: #101010;
    }
    #overlay-header-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #overlay-title {
      font-size: 14px;
      color: #aaa;
      max-width: 60vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .overlay-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      border: 1px solid #333;
      background: #181818;
      color: #f5f5f5;
      width: 30px;
      height: 30px;
      font-size: 18px;
      padding: 0;
    }
    #overlay-back {
      display: none;
    }
    #overlay.has-stack #overlay-back {
      display: inline-flex;
    }
    #overlay-content {
      padding: 12px 16px 24px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      font-size: 17px;
      line-height: 1.6;
      overflow-wrap: break-word;
      word-wrap: break-word;
    }
    #overlay-content * {
      font-size: inherit !important;
      line-height: inherit !important;
      white-space: normal !important;
    }
    #overlay-content a {
      color: #6ab4ff;
      text-decoration: underline;
      text-decoration-thickness: 1px;
      text-underline-offset: 2px;
    }

    #tooltip {
      display: none;
    }

    @media (max-width: 480px) {
      main {
        padding-inline: 14px;
        font-size: 16px;
      }
      #overlay-content {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1 id="chapter-title">Ada – Mobile</h1>
      <select id="chapter-select"></select>
    </header>
    <main>
      <div id="text">Loading…</div>
    </main>
  </div>

  <div id="tooltip"></div>

  <div id="overlay">
    <div id="overlay-inner">
      <div id="overlay-header">
        <div id="overlay-header-left">
          <button id="overlay-back" class="overlay-btn">‹</button>
          <span id="overlay-title">Commentary</span>
        </div>
        <button id="overlay-close" class="overlay-btn">✕</button>
      </div>
      <div id="overlay-content"></div>
    </div>
  </div>

<script>
    const ADA_BASE = 'https://www.ada.auckland.ac.nz/';

    const chapterSelect   = document.getElementById('chapter-select');
    const chapterTitle    = document.getElementById('chapter-title');
    const textContainer   = document.getElementById('text');
    const tooltip         = document.getElementById('tooltip');
    const overlay         = document.getElementById('overlay');
    const overlayContent  = document.getElementById('overlay-content');
    const overlayTitle    = document.getElementById('overlay-title');
    const overlayClose    = document.getElementById('overlay-close');
    const overlayBack     = document.getElementById('overlay-back');

    let notesDom = null;
    let notesHtml = '';
    let overlayStack = [];

    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    }

    async function loadChapterList() {
      const chapters = await fetchJSON('/api/chapters');
      chapterSelect.innerHTML = '';
      chapters.forEach((ch, idx) => {
        const opt = document.createElement('option');
        opt.value = ch.id;
        opt.textContent = ch.title;
        if (idx === 0) opt.selected = true;
        chapterSelect.appendChild(opt);
      });
      if (chapters.length) {
        await loadChapter(chapters[0].id);
      } else {
        textContainer.textContent = 'No chapters configured yet.';
      }
    }

    async function loadChapter(id) {
      textContainer.textContent = 'Loading…';
      tooltip.style.display = 'none';
      closeOverlayCompletely();

      const data = await fetchJSON('/api/chapter/' + encodeURIComponent(id));

      chapterTitle.textContent = data.title;
      textContainer.innerHTML = data.textHtml || '';
      notesHtml = data.notesHtml || '';

      const doc = new DOMParser().parseFromString(
        '<div id="notes-root">' + notesHtml + '</div>',
        'text/html'
      );
      notesDom = doc.getElementById('notes-root');

      wireTextLinks(textContainer);
    }

    function isAdaNoteHref(href) {
      if (!href) return true;
      href = href.trim();
      if (href === '' || href === '#') return true;
      if (href.startsWith('#')) return true;
      if (/ada\d+ann\.htm/i.test(href)) return true; // annotation files
      return false;
    }

    function isRelativeAdaDoc(href) {
      if (!href) return false;
      if (/^https?:\/\//i.test(href)) {
        return /^https?:\/\/www\.ada\.auckland\.ac\.nz/i.test(href);
      }
      // motifs.htm, persons.htm, ada11.htm#3.04, etc.
      return /\.htm(\?|#|$)/i.test(href);
    }

    function makeAdaAbsolute(href) {
      if (!href) return ADA_BASE;
      if (/^https?:\/\//i.test(href)) return href;
      return ADA_BASE + href.replace(/^\/+/, '');
    }

    function wireTextLinks(root) {
      const links = root.querySelectorAll('a');
      links.forEach(a => {
        const rawHref = a.getAttribute('href') || '';

        if (isAdaNoteHref(rawHref)) {
          a.classList.add('note-link');
          a.addEventListener('click', onNoteClick);
        } else if (isRelativeAdaDoc(rawHref)) {
          const abs = makeAdaAbsolute(rawHref);
          a.setAttribute('href', abs);
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
        } else {
          if (rawHref && !/^https?:\/\//i.test(rawHref)) {
            a.href = rawHref;
          }
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
        }
      });
    }

    function wireOverlayLinks() {
      const links = overlayContent.querySelectorAll('a');
      links.forEach(a => {
        const rawHref = a.getAttribute('href') || '';

        if (isAdaNoteHref(rawHref)) {
          a.addEventListener('click', onOverlayNoteClick);
        } else if (isRelativeAdaDoc(rawHref)) {
          const abs = makeAdaAbsolute(rawHref);
          a.setAttribute('href', abs);
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
        } else {
          if (rawHref && !/^https?:\/\//i.test(rawHref)) {
            a.href = rawHref;
          }
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
        }
      });
    }

    function onNoteClick(ev) {
      ev.preventDefault();
      ev.stopPropagation();
      const phrase = (ev.currentTarget.textContent || '').trim();
      openNoteForPhrase(phrase);
    }

    function onOverlayNoteClick(ev) {
      ev.preventDefault();
      ev.stopPropagation();
      const phrase = (ev.currentTarget.textContent || '').trim();
      openNoteForPhrase(phrase);
    }

    function normalize(str) {
      return str.replace(/\s+/g, ' ').trim().toLowerCase();
    }

    function findNoteSnippet(phrase) {
      const normPhrase = normalize(phrase);
      if (!normPhrase || !notesDom) return '';

      const candidates = Array.from(notesDom.querySelectorAll('p, div, li, dd'));
      let best = null;
      let bestLen = Infinity;

      for (const el of candidates) {
        const text = normalize(el.textContent || '');
        if (!text) continue;
        const idx = text.indexOf(normPhrase);
        if (idx !== -1 && text.length < bestLen) {
          best = el;
          bestLen = text.length;
        }
      }

      if (best) {
        const buf = [best.outerHTML];
        let next = best.nextElementSibling;
        while (next && buf.length < 4) {
          const t = normalize(next.textContent || '');
          if (!t) break;
          buf.push(next.outerHTML);
          next = next.nextElementSibling;
        }
        return buf.join('\n');
      }

      const fullText = normalize(notesDom.textContent || '');
      if (fullText.includes(normPhrase)) return '';

      return '';
    }

    function openNoteForPhrase(phrase) {
      if (!notesDom) {
        pushOverlay(notesHtml, 'Commentary');
        return;
      }
      const snippet = phrase ? findNoteSnippet(phrase) : '';
      const html = snippet || notesHtml;
      const title = phrase || 'Commentary';
      pushOverlay(html, title);
    }

    function pushOverlay(html, title) {
      overlayStack.push({ html: html || '<p>No commentary found.</p>', title });
      renderOverlay();
    }

    function renderOverlay() {
      if (!overlayStack.length) {
        closeOverlayCompletely();
        return;
      }
      const top = overlayStack[overlayStack.length - 1];
      overlayContent.innerHTML = top.html;
      overlayTitle.textContent = top.title || 'Commentary';
      overlay.classList.add('visible');
      if (overlayStack.length > 1) {
        overlay.classList.add('has-stack');
      } else {
        overlay.classList.remove('has-stack');
      }
      wireOverlayLinks();
    }

    function popOverlay() {
      if (overlayStack.length > 1) {
        overlayStack.pop();
        renderOverlay();
      } else {
        closeOverlayCompletely();
      }
    }

    function closeOverlayCompletely() {
      overlayStack = [];
      overlay.classList.remove('visible');
      overlay.classList.remove('has-stack');
      overlayContent.innerHTML = '';
    }

    overlayBack.addEventListener('click', () => {
      popOverlay();
    });

    overlayClose.addEventListener('click', () => {
      closeOverlayCompletely();
    });

    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        closeOverlayCompletely();
      }
    });

    chapterSelect.addEventListener('change', () => {
      const id = chapterSelect.value;
      loadChapter(id).catch(err => {
        console.error(err);
        textContainer.textContent = 'Failed to load chapter.';
      });
    });

    loadChapterList().catch(err => {
      console.error(err);
      textContainer.textContent = 'Failed to load chapter list.';
    });
  </script>

</body>
</html>
